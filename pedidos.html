<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FARMACIA BOLA√ëOS - Despachos</title>
    <link rel="icon" type="image/png" href="https://hebbkx1anhila5yf.public.blob.vercel-storage.com/logo.png-aDTYH1bst5kbULe4iWpNW4HASl8UN8.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="estilos.css">
    
    <!-- Agregando librer√≠a html2canvas para convertir HTML a imagen -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>
    <svg style="position: absolute; width: 0; height: 0;">
    <defs>
        <linearGradient id="gaugeGradient" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%" style="stop-color:#ff6b00"/>
            <stop offset="50%" style="stop-color:#ff9500"/>
            <stop offset="100%" style="stop-color:#ffcc00"/>
        </linearGradient>
    </defs>
</svg>
<div class="container">
    <div class="header">
        <div class="header-left">
            
        </div>
        <div class="header-buttons">
            <button class="btn-recargar" onclick="recargarDatos()">üîÑ Recargar</button>
            <button class="btn-generar" onclick="generarReporte()">üìÑ Reporte</button>
        </div>
    </div>

    <div class="stats">
        <div class="stat-card"><h3>Total Requi</h3><p id="statTotalRequi">0</p></div>
        <div class="stat-card" style="background: linear-gradient(135deg, #7cb342 0%, #558b2f 100%);"><h3>Total Des</h3><p id="statTotalDes">0</p></div>
        <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);"><h3>Completitup</h3><p id="statCompletitup">0%</p></div>
        
            <div class="stat-card" style="background: linear-gradient(135deg, #ffa726 0%, #fb8c00 100%);">
    <h3>SKU</h3>
    <p id="statSKU">0</p>
    <button class="btn-ver-reporte" onclick="abrirModalPorcentajeSKU()">
        üìà Ver Eficiencia SKU
    </button>
</div>
        <!-- Agregando bot√≥n de reporte en la tarjeta SKU Sin Des -->
        <div class="stat-card stat-card-with-button" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
            <h3>SKU Sin Des</h3>
            <p id="statSKUSinDes">0</p>
            <button class="btn-ver-reporte" onclick="abrirReporteSKUSinDes()">
                üìä Ver Reporte Detallado
            </button>
        </div>
        <div class="stat-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);"><h3>Cantidad P</h3><p id="statCantidadP">0</p></div>
    </div>

 <div class="filter-section">
    <div class="filter-container">
        <span class="filter-label">üîç Filtrar por Fecha:</span>
        
        <!-- Modo de filtro -->
        <select id="filterMode" class="filter-input" style="flex: 0.8; min-width: 150px;" onchange="cambiarModoFiltro()">
            <option value="exacta">Fecha Exacta</option>
            <option value="rango">Rango de Fechas</option>
            <option value="mes">Por Mes y A√±o</option>
        </select>

        <!-- Contenedor para Fecha Exacta -->
        <div id="filtroFechaExacta" class="filtro-modo">
            <input type="date" id="filterDate" class="filter-input">
            <span class="filter-label">‚è∞ Hora (opcional):</span>
            <input type="time" id="filterTime" class="filter-input-time" placeholder="HH:MM">
        </div>

        <!-- Contenedor para Rango de Fechas -->
        <div id="filtroRango" class="filtro-modo" style="display: none;">
            <span class="filter-label">Desde:</span>
            <input type="date" id="filterDateFrom" class="filter-input">
            <span class="filter-label">Hasta:</span>
            <input type="date" id="filterDateTo" class="filter-input">
        </div>

        <!-- Contenedor para Mes y A√±o -->
        <div id="filtroMesA√±o" class="filtro-modo" style="display: none;">
            <select id="filterMonth" class="filter-input" style="flex: 0.6; min-width: 120px;">
                <option value="">Selecciona Mes</option>
                <option value="01">Enero</option>
                <option value="02">Febrero</option>
                <option value="03">Marzo</option>
                <option value="04">Abril</option>
                <option value="05">Mayo</option>
                <option value="06">Junio</option>
                <option value="07">Julio</option>
                <option value="08">Agosto</option>
                <option value="09">Septiembre</option>
                <option value="10">Octubre</option>
                <option value="11">Noviembre</option>
                <option value="12">Diciembre</option>
            </select>
            <input type="number" id="filterYear" class="filter-input" placeholder="YYYY" min="2020" max="2099" style="flex: 0.4; min-width: 80px;">
        </div>

        <button class="btn-filtrar" onclick="filtrarPorFecha()">Filtrar</button>
        <button class="btn-limpiar" onclick="limpiarFiltro()">Limpiar</button>
    </div>
</div>

    <div class="table-wrapper">
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>FECHA Y HORA</th>
                    <th>CODIGO</th>
                    <th>PRODUCTO</th>
                    <th>LABORATORIO</th>
                    <th>CANTIDAD</th>
                    <th>INICIO</th>
                    <th>FIN</th>
                    <th>PIKER</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<!-- Removiendo bot√≥n X del modal header -->
<div id="modalReporteSKU" class="modal-overlay" onclick="cerrarModalSiClickFuera(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h2>üìä Reporte Detallado - SKU Sin Despachar</h2>
        </div>
        <div class="modal-body">
            <div class="modal-info">
                <p id="modalInfoText"><strong>Informaci√≥n:</strong> Este reporte muestra todas las requisiciones con cantidad 0 que cumplen los criterios de SKU Sin Despachar (campos de despacho rellenados, sin palabras clave inv√°lidas).</p>
            </div>
            <div class="modal-table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>FECHA Y HORA</th>
                            <th>CODIGO</th>
                            <th>PRODUCTO</th>
                            <th>LABORATORIO</th>
                            <th>CANTIDAD</th>
                            <th>SOLICITADO</th>
                            <th>INICIO</th>
                            <th>FIN</th>
                            <th>PIKER</th>
                        </tr>
                    </thead>
                    <tbody id="modalTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Agregando modal para generaci√≥n de reportes -->
<div id="modalGenerarReporte" class="modal-reporte-overlay">
    <div class="modal-reporte-content">
        <div class="modal-reporte-header">
            <h2>üìÑ Generar Reporte de Despachos</h2>
        </div>
        
        <div class="modal-reporte-body">
            <div class="form-group">
                <label class="form-label">Comentario (Opcional)</label>
                <textarea 
                    id="reporteComentario" 
                    class="form-textarea" 
                    placeholder="Agregue un comentario o nota para este reporte..."
                    oninput="actualizarVistaPrevia()"
                ></textarea>
            </div>
            
            <div class="form-group">
                <label class="form-label">Vista Previa del Reporte</label>
                <div id="reportePreview" class="reporte-preview">
                    <!-- El contenido se generar√° din√°micamente -->
                </div>
            </div>
        </div>
        
        <div class="modal-reporte-actions">
            <button class="btn-modal-action btn-cancelar" onclick="cerrarModalReporte()">Cancelar</button>
            <button class="btn-modal-action btn-descargar" onclick="descargarReporte()">üì• Descargar Reporte</button>
        </div>
    </div>
</div>
<script>function cerrarModalSiClickFuera(event) {
    const overlay = document.getElementById('modalReporteSKU');
    const contenido = overlay.querySelector('.modal-content');
    
    // Si el clic fue en el overlay (fuera del contenido), cierra el modal
    if (!contenido.contains(event.target)) {
        cerrarReporteSKUSinDes();
    }
}


</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
<script>
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQFZUyjvlU7g4HUvzNfJOAJAbkEKnYwAeBnTeeiZEJrvU0_-VyTfQHHAIJqb1GO9WyBuN3TYlBmXEBG/pub?gid=693750954&single=true&output=csv";
let tablaDatos = [];
const MAX_FILAS_INICIAL = 10;

let estadisticasCache1 = null;
let datosSKUSinDesCache = null;
let modalHTMLCache = null;

let filtroActivo = {
    fecha: null,
    hora: null
};

let autoRefreshInterval;
let lastInteractionTime = Date.now();
const AUTO_REFRESH_DELAY = 60000;

let debounceTimer;
function resetInteractionTimer() {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(() => {
        lastInteractionTime = Date.now();
    }, 300);
}

document.addEventListener('click', resetInteractionTimer);
document.addEventListener('keypress', resetInteractionTimer);
document.addEventListener('scroll', resetInteractionTimer);
document.addEventListener('mousemove', resetInteractionTimer);

function iniciarAutoRefresh() {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
    }
    
    autoRefreshInterval = setInterval(() => {
        const tiempoSinInteraccion = Date.now() - lastInteractionTime;
        
        if (tiempoSinInteraccion >= AUTO_REFRESH_DELAY) {
            obtenerDatosCSV();
        }
    }, 45000);
}

function recargarDatos() {
    const btn = event.target;
    const textoOriginal = btn.innerHTML;
    btn.innerHTML = '‚è≥ Esperando actualizaci√≥n...';
    btn.disabled = true;
    
    setTimeout(() => {
        btn.innerHTML = '‚è≥ Recargando datos...';
        obtenerDatosCSV().then(() => {
            btn.innerHTML = '‚úÖ Datos Actualizados';
            setTimeout(() => {
                btn.innerHTML = textoOriginal;
                btn.disabled = false;
            }, 1500);
        }).catch(() => {
            btn.innerHTML = '‚ùå Error al recargar';
            setTimeout(() => {
                btn.innerHTML = textoOriginal;
                btn.disabled = false;
            }, 2000);
        });
    }, 2000);
}

function obtenerValor(fila, nombresColumnas) {
    // Primero intentar coincidencia exacta
    for (let nombre of nombresColumnas) {
        if (fila[nombre] !== undefined && fila[nombre] !== null && fila[nombre] !== '') {
            return fila[nombre];
        }
    }
    
    // Si no hay coincidencia exacta, intentar con normalizaci√≥n
    const columnasDisponibles = Object.keys(fila);
    const normalizarNombre = (str) => str.toLowerCase().replace(/[_\s-]/g, '');
    
    for (let nombreBuscado of nombresColumnas) {
        const nombreNormalizado = normalizarNombre(nombreBuscado);
        for (let columnaReal of columnasDisponibles) {
            if (normalizarNombre(columnaReal) === nombreNormalizado) {
                if (fila[columnaReal] !== undefined && fila[columnaReal] !== null && fila[columnaReal] !== '') {
                    return fila[columnaReal];
                }
            }
        }
    }
    
    return '';
}


// Nueva funci√≥n para determinar si una requisici√≥n debe contarse como despachada en Total Des
function esRequiDespachada(fila) {
    // Si contiene palabras clave inv√°lidas, se considera despachada
    if (filaContieneEstadoInvalido(fila)) {
        return true;
    }
    
    // Si no tiene palabras clave, verificar que los campos de despacho est√©n rellenados
    return camposDespachoRellenados(fila);
}

function camposDespachoRellenados(fila) {
    const horaInicio = obtenerValor(fila, ["INICIO", "HORA_INICIO", "HORA INICIO", "Hora Inicio", "hora_inicio", "HORA_DESPACHO", "HORA DESPACHO"]);
    const horaFin = obtenerValor(fila, ["FIN", "HORA_FIN", "HORA FIN", "Hora Fin", "hora_fin"]);
    const piker = obtenerValor(fila, ["PIKER", "Piker", "piker", "PICKER", "Picker"]);
    
    const palabrasClaveInvalidas = ['ANULADO', 'PRUEBA', 'CANCELADO', 'SIN EXISTENCIAS', 'DEVOLUCION', 'PENDIENTE'];
    
    const estaRellenadoConDatosNormales = (valor) => {
        if (!valor || valor === '-' || valor.toString().trim() === '') return false;
        
        const valorUpper = valor.toString().toUpperCase().trim();
        
        // Si contiene alguna palabra clave inv√°lida, NO est√° rellenado con datos normales
        for (let palabra of palabrasClaveInvalidas) {
            if (valorUpper.includes(palabra)) {
                return false;
            }
        }
        
        // Si llegamos aqu√≠, tiene datos normales
        return true;
    };
    
    return estaRellenadoConDatosNormales(horaInicio) && 
           estaRellenadoConDatosNormales(horaFin) && 
           estaRellenadoConDatosNormales(piker);
}

function esEstadoInvalido(valor) {
    if (!valor) return false;
    const valorUpper = valor.toString().toUpperCase().trim();
    const estadosInvalidos = ['ANULADO', 'PRUEBA', 'CANCELADO', 'SIN EXISTENCIAS', 'DEVOLUCION', 'PENDIENTE'];
    return estadosInvalidos.includes(valorUpper);
}

function filaContieneEstadoInvalido(fila) {
    const palabrasInvalidas = ['ANULADO', 'PRUEBA', 'CANCELADO', 'SIN EXISTENCIAS', 'DEVOLUCION', 'PENDIENTE'];
    
    for (let campo in fila) {
        const valor = fila[campo];
        if (valor && typeof valor === 'string') {
            const valorUpper = valor.toUpperCase().trim();
            for (let palabraInvalida of palabrasInvalidas) {
                if (valorUpper.includes(palabraInvalida)) {
                    return true;
                }
            }
        }
    }
    return false;
}


function cumpleFiltroFechaHora(fila) {
    // Si no hay filtro activo, todas las filas cumplen
    if (!filtroActivo.fecha) {
        return true;
    }
    
    const fechaHora = obtenerValor(fila, ["FECHA_Y_HORA", "FECHA Y HORA", "Fecha y Hora"]);
    if (!fechaHora) return false;
    
    const partes = fechaHora.split(' ');
    if (!partes[0]) return false;
    
    const [dia, mes, a√±o] = partes[0].split('/');
    if (!dia || !mes || !a√±o) return false;
    
    const fechaFilaFormateada = `${a√±o}-${mes.padStart(2, '0')}-${dia.padStart(2, '0')}`;
    
    // Verificar fecha
    if (fechaFilaFormateada !== filtroActivo.fecha) {
        return false;
    }
    
    // Verificar hora si est√° presente
    if (filtroActivo.hora) {
        const horaFila = partes[1];
        if (!horaFila) return false;
        
        const [horaFilaHH, horaFilaMM] = horaFila.split(':');
        const horaFilaFormateada = `${horaFilaHH}:${horaFilaMM}`;
        
        return horaFilaFormateada === filtroActivo.hora;
    }
    
    return true;
}

function calcularEstadisticas(datos) {
    // Usar cach√© si los datos no han cambiado
    if (estadisticasCache && estadisticasCache.datosLength === datos.length) {
        actualizarUIEstadisticas(estadisticasCache);
        return;
    }
    
    const idsUnicos = new Set();
    const requiPorId = {};
    const codigosUnicos = new Set();
    const codigosSinDespachar = new Set();
    let cantidadTotal = 0;
    
    datos.forEach(fila => {
        const id = obtenerValor(fila, ["ID", "id"]);
        const codigo = obtenerValor(fila, ["CODIGO", "Codigo", "codigo"]);
        const cantidad = obtenerValor(fila, ["CANTIDAD", "Cantidad", "cantidad"]);
        const horaInicio = obtenerValor(fila, ["INICIO", "HORA_INICIO", "HORA INICIO", "Hora Inicio", "hora_inicio", "HORA_DESPACHO", "HORA DESPACHO"]);
        const horaFin = obtenerValor(fila, ["FIN", "HORA_FIN", "HORA FIN", "Hora Fin", "hora_fin"]);
        
        // Total Requi
        if (id && id !== '-') {
            idsUnicos.add(id);
            if (!requiPorId[id]) {
                requiPorId[id] = [];
            }
            requiPorId[id].push(fila);
        }
        
        // SKU
        if (!esEstadoInvalido(horaInicio) && !esEstadoInvalido(horaFin)) {
            if (codigo && codigo !== '-') {
                codigosUnicos.add(codigo);
            }
            
            // Cantidad P
            const cantidadNum = parseFloat(cantidad) || 0;
            cantidadTotal += cantidadNum;
        }
        
        if ((cantidad === '0' || cantidad === 0) && codigo && codigo !== '-') {
            // Verificar que los campos de despacho est√©n rellenados con datos normales (sin palabras clave)
            if (camposDespachoRellenados(fila)) {
                codigosSinDespachar.add(codigo);
            }
        }
    });
    
    const totalRequi = idsUnicos.size;
    
    // Total Des ahora cuenta requisiciones con palabras clave como despachadas
    let totalDes = 0;
    for (let id in requiPorId) {
        const filas = requiPorId[id];
        // Una requisici√≥n se considera despachada si:
        // 1. Todas sus filas tienen palabras clave inv√°lidas, O
        // 2. Todas sus filas tienen los campos de despacho rellenados
        const todasDespachadas = filas.every(fila => esRequiDespachada(fila));
        if (todasDespachadas) {
            totalDes++;
        }
    }
    
    const completitup = totalRequi > 0 ? ((totalDes / totalRequi) * 100).toFixed(1) : 0;
    const totalSKU = codigosUnicos.size;
    const totalSKUSinDes = codigosSinDespachar.size;
    
    estadisticasCache = {
        datosLength: datos.length,
        totalRequi,
        totalDes,
        completitup,
        totalSKU,
        totalSKUSinDes,
        cantidadTotal
    };
    
    actualizarUIEstadisticas(estadisticasCache);
}

function actualizarUIEstadisticas(stats) {
    document.getElementById('statTotalRequi').textContent = stats.totalRequi.toLocaleString();
    document.getElementById('statTotalDes').textContent = stats.totalDes.toLocaleString();
    document.getElementById('statCompletitup').textContent = stats.completitup + '%';
    document.getElementById('statSKU').textContent = stats.totalSKU.toLocaleString();
    document.getElementById('statSKUSinDes').textContent = stats.totalSKUSinDes.toLocaleString();
    document.getElementById('statCantidadP').textContent = stats.cantidadTotal.toLocaleString();
}

async function obtenerDatosCSV() {
    try {
        const timestamp = new Date().getTime();
        const random = Math.random().toString(36).substring(7);
        const urlConCacheBusting = `${CSV_URL}&_=${timestamp}&r=${random}`;
        
        const response = await fetch(urlConCacheBusting, {
            cache: 'no-store'
        });
        
        const csvText = await response.text();
        const resultados = Papa.parse(csvText, { header: true, skipEmptyLines: true });
        tablaDatos = resultados.data;
        
        console.log('[v0] ===== DEPURACI√ìN DE DATOS CSV =====');
        console.log('[v0] Total de filas cargadas:', tablaDatos.length);
        
        if (tablaDatos.length > 0) {
            console.log('[v0] Columnas disponibles en el CSV:', Object.keys(tablaDatos[0]));
            console.log('[v0] Primera fila de ejemplo:', tablaDatos[0]);
            console.log('[v0] Segunda fila de ejemplo:', tablaDatos[1]);
        } else {
            console.log('[v0] ‚ö†Ô∏è NO SE CARGARON DATOS. El CSV est√° vac√≠o o hay un error.');
        }
        console.log('[v0] ===================================');
        
        estadisticasCache = null;
        datosSKUSinDesCache = null;
        modalHTMLCache = null;
        
        const datosInvertidos = [...tablaDatos].reverse();
        mostrarDatos(datosInvertidos.slice(0, MAX_FILAS_INICIAL));
        calcularEstadisticas(tablaDatos);
    } catch (error) {
        console.error('[v0] ‚ùå Error al obtener datos CSV:', error);
        console.error('[v0] Detalles del error:', error.message);
        alert('Error al cargar los datos. Por favor, intenta recargar la p√°gina.');
        throw error;
    }
}

function mostrarDatos(datos) {
    const tbody = document.getElementById('tableBody');
    const fragment = document.createDocumentFragment();
    
    console.log('[v0] Mostrando', datos.length, 'filas en la tabla');
    
    datos.forEach((fila, index) => {
        const tr = document.createElement('tr');
        
        const id = obtenerValor(fila, ["ID", "id", "Id", "iD"]);
        const fecha = obtenerValor(fila, ["FECHA_Y_HORA", "FECHA Y HORA", "Fecha y Hora", "fecha_y_hora", "FechaYHora", "FECHAYHORA", "Fecha", "FECHA"]);
        const codigo = obtenerValor(fila, ["CODIGO", "Codigo", "codigo", "C√≥digo", "C√ìDIGO", "Code", "CODE"]);
        const producto = obtenerValor(fila, ["PRODUCTO", "Producto", "producto", "Product", "PRODUCT"]);
        const laboratorio = obtenerValor(fila, ["LABORATORIO", "Laboratorio", "laboratorio", "Lab", "LAB"]);
        const cantidad = obtenerValor(fila, ["CANTIDAD", "Cantidad", "cantidad", "Qty", "QTY", "Cant", "CANT"]);
        const horaInicio = obtenerValor(fila, ["INICIO", "HORA_INICIO", "HORA INICIO", "Hora Inicio", "hora_inicio", "HORA_DESPACHO", "HORA DESPACHO", "HoraInicio", "HORAINICIO"]);
        const horaFin = obtenerValor(fila, ["FIN", "HORA_FIN", "HORA FIN", "Hora Fin", "hora_fin", "HoraFin", "HORAFIN"]);
        const piker = obtenerValor(fila, ["PIKER", "Piker", "piker", "PICKER", "Picker", "picker"]);
        
        if (index === 0) {
            console.log('[v0] Valores extra√≠dos de la primera fila:');
            console.log('[v0] ID:', id);
            console.log('[v0] Fecha:', fecha);
            console.log('[v0] C√≥digo:', codigo);
            console.log('[v0] Producto:', producto);
            console.log('[v0] Laboratorio:', laboratorio);
            console.log('[v0] Cantidad:', cantidad);
            console.log('[v0] Hora Inicio:', horaInicio);
            console.log('[v0] Hora Fin:', horaFin);
            console.log('[v0] Piker:', piker);
        }
        
        tr.innerHTML = `
            <td>${id || '-'}</td>
            <td>${fecha || '-'}</td>
            <td>${codigo || '-'}</td>
            <td>${producto || '-'}</td>
            <td>${laboratorio || '-'}</td>
            <td>${cantidad || '-'}</td>
            <td>${horaInicio || '-'}</td>
            <td>${horaFin || '-'}</td>
            <td>${piker || '-'}</td>
        `;
        fragment.appendChild(tr);
    });
    
    tbody.innerHTML = '';
    tbody.appendChild(fragment);
}


function cambiarModoFiltro() {
    const modo = document.getElementById('filterMode').value;
    document.getElementById('filtroFechaExacta').style.display = modo === 'exacta' ? 'flex' : 'none';
    document.getElementById('filtroRango').style.display = modo === 'rango' ? 'flex' : 'none';
    document.getElementById('filtroMesA√±o').style.display = modo === 'mes' ? 'flex' : 'none';
}

function filtrarPorFecha() {
    const modo = document.getElementById('filterMode').value;
    let datosFiltrados = [];

    if (modo === 'exacta') {
        datosFiltrados = filtrarPorFechaExacta();
    } else if (modo === 'rango') {
        datosFiltrados = filtrarPorRango();
    } else if (modo === 'mes') {
        datosFiltrados = filtrarPorMesA√±o();
    }

    if (datosFiltrados.length === 0) {
        alert('No se encontraron registros para los filtros seleccionados');
        return;
    }

    estadisticasCache = null;
    mostrarDatos(datosFiltrados.reverse());
    calcularEstadisticas(datosFiltrados);
}

function filtrarPorFechaExacta() {
    const filterDateValue = document.getElementById('filterDate').value;
    const filterTimeValue = document.getElementById('filterTime').value;
    
    if (!filterDateValue) { 
        alert('Seleccione una fecha para filtrar'); 
        return []; 
    }
    
    filtroActivo.fecha = filterDateValue;
    filtroActivo.hora = filterTimeValue || null;
    modalHTMLCache = null;
    datosSKUSinDesCache = null;
    
    const fechaFiltro = filterDateValue;
    
    return tablaDatos.filter(fila => {
        const fechaHora = obtenerValor(fila, ["FECHA_Y_HORA", "FECHA Y HORA", "Fecha y Hora"]);
        if(!fechaHora) return false;
        
        const partes = fechaHora.split(' ');
        if(!partes[0]) return false;
        
        const [dia, mes, a√±o] = partes[0].split('/');
        if(!dia || !mes || !a√±o) return false;
        
        const fechaFilaFormateada = `${a√±o}-${mes.padStart(2, '0')}-${dia.padStart(2, '0')}`;
        
        if (fechaFilaFormateada !== fechaFiltro) {
            return false;
        }
        
        if (filterTimeValue) {
            const horaFila = partes[1];
            if (!horaFila) return false;
            
            const [horaFilaHH, horaFilaMM] = horaFila.split(':');
            const horaFilaFormateada = `${horaFilaHH}:${horaFilaMM}`;
            
            return horaFilaFormateada === filterTimeValue;
        }
        
        return true;
    });
}

function filtrarPorRango() {
    const filterDateFrom = document.getElementById('filterDateFrom').value;
    const filterDateTo = document.getElementById('filterDateTo').value;
    
    if (!filterDateFrom || !filterDateTo) { 
        alert('Seleccione ambas fechas (desde y hasta)'); 
        return []; 
    }

    if (filterDateFrom > filterDateTo) {
        alert('La fecha "desde" debe ser menor que la fecha "hasta"');
        return [];
    }
    
    filtroActivo.fechaDesde = filterDateFrom;
    filtroActivo.fechaHasta = filterDateTo;
    modalHTMLCache = null;
    datosSKUSinDesCache = null;
    
    return tablaDatos.filter(fila => {
        const fechaHora = obtenerValor(fila, ["FECHA_Y_HORA", "FECHA Y HORA", "Fecha y Hora"]);
        if(!fechaHora) return false;
        
        const partes = fechaHora.split(' ');
        if(!partes[0]) return false;
        
        const [dia, mes, a√±o] = partes[0].split('/');
        if(!dia || !mes || !a√±o) return false;
        
        const fechaFilaFormateada = `${a√±o}-${mes.padStart(2, '0')}-${dia.padStart(2, '0')}`;
        
        return fechaFilaFormateada >= filterDateFrom && fechaFilaFormateada <= filterDateTo;
    });
}

function filtrarPorMesA√±o() {
    const filterMonth = document.getElementById('filterMonth').value;
    const filterYear = document.getElementById('filterYear').value;
    
    if (!filterMonth || !filterYear) { 
        alert('Seleccione mes y a√±o'); 
        return []; 
    }

    if (filterYear.length !== 4 || isNaN(filterYear)) {
        alert('Ingrese un a√±o v√°lido (YYYY)');
        return [];
    }
    
    filtroActivo.mes = filterMonth;
    filtroActivo.a√±o = filterYear;
    modalHTMLCache = null;
    datosSKUSinDesCache = null;
    
    return tablaDatos.filter(fila => {
        const fechaHora = obtenerValor(fila, ["FECHA_Y_HORA", "FECHA Y HORA", "Fecha y Hora"]);
        if(!fechaHora) return false;
        
        const partes = fechaHora.split(' ');
        if(!partes[0]) return false;
        
        const [dia, mes, a√±o] = partes[0].split('/');
        if(!dia || !mes || !a√±o) return false;
        
        return mes === filterMonth && a√±o === filterYear;
    });
}

function limpiarFiltro() {

    // Verificar si hay alg√∫n filtro activo
    const hayFiltrosActivos =
        (document.getElementById('filterDate').value !== '') ||
        (document.getElementById('filterTime').value !== '') ||
        (document.getElementById('filterDateFrom').value !== '') ||
        (document.getElementById('filterDateTo').value !== '') ||
        (document.getElementById('filterMonth').value !== '') ||
        (document.getElementById('filterYear').value !== '') ||
        (document.getElementById('filterMode').value !== 'exacta');

    // Si no hay filtros activos ‚Üí no hacer nada
    if (!hayFiltrosActivos) {
        return;
    }

    // Si hay filtros activos ‚Üí recargar la p√°gina para dejar todo limpio
    location.reload();
}



function generarIDReporteUnico() {
    const ahora = new Date();
    const a√±o = ahora.getFullYear();
    const mes = String(ahora.getMonth() + 1).padStart(2, '0');
    const dia = String(ahora.getDate()).padStart(2, '0');
    const hora = String(ahora.getHours()).padStart(2, '0');
    const minuto = String(ahora.getMinutes()).padStart(2, '0');
    const segundo = String(ahora.getSeconds()).padStart(2, '0');
    const milisegundo = String(ahora.getMilliseconds()).padStart(3, '0');
    
    // Generar n√∫mero aleatorio adicional para garantizar unicidad
    const random = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
    
    // Formato: REPORTE + A√ëO + MES + DIA + HORA + MINUTO + SEGUNDO + RANDOM
    const idUnico = `REPORTE${a√±o}${mes}${dia}${hora}${minuto}${segundo}${random}`;
    
    return idUnico;
}

function generarReporte() {
    abrirModalReporte();
}

function abrirModalReporte() {
    actualizarVistaPrevia();
    document.getElementById('modalGenerarReporte').classList.add('active');
    document.body.style.overflow = 'hidden';
}

function cerrarModalReporte() {
    document.getElementById('modalGenerarReporte').classList.remove('active');
    document.getElementById('reporteComentario').value = '';
    document.body.style.overflow = 'auto';
}

async function descargarReporte() {
    const btn = event.target;
    const textoOriginal = btn.innerHTML;
    btn.innerHTML = '‚è≥ Generando imagen...';
    btn.disabled = true;
    
    try {
        const reporteElement = document.getElementById('reportePreview');
        const reporteID = reporteElement.dataset.reporteId || 'REPORTE';
        
        // Configurar html2canvas para mejor calidad
        const canvas = await html2canvas(reporteElement, {
            scale: 2, // Mayor resoluci√≥n
            backgroundColor: '#ffffff',
            logging: false,
            useCORS: true,
            allowTaint: true
        });
        
        // Convertir canvas a blob
        canvas.toBlob(function(blob) {
            const nombreArchivo = `${reporteID}.png`;
            
            // Crear enlace de descarga
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = nombreArchivo;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            btn.innerHTML = '‚úÖ Descargado';
            
            // Mostrar mensaje informativo y restaurar bot√≥n
    setTimeout(() => {
        cerrarModalReporte();
        btn.innerHTML = textoOriginal;
        btn.disabled = false;
    }, 1000);
}, 'image/png')
        
    } catch (error) {
        console.error('[v0] Error al generar reporte:', error);
        alert('Error al generar el reporte. Por favor, intenta nuevamente.');
        btn.innerHTML = textoOriginal;
        btn.disabled = false;
    }
}

function actualizarVistaPrevia() {
    const comentario = document.getElementById('reporteComentario').value;
    const ahora = new Date();
    
    const reporteID = generarIDReporteUnico();
    
    const fechaFormateada = ahora.toLocaleDateString('es-SV', { 
        day: '2-digit', 
        month: '2-digit', 
        year: 'numeric' 
    });
    const horaFormateada = ahora.toLocaleTimeString('es-SV', { 
        hour: '2-digit', 
        minute: '2-digit',
        second: '2-digit',
        hour12: false
    });
    
    // Calcular fecha de validez (30 d√≠as despu√©s)
    const fechaValidez = new Date(ahora);
    fechaValidez.setDate(fechaValidez.getDate() + 30);
    const fechaValidezFormateada = fechaValidez.toLocaleDateString('es-SV', { 
        day: '2-digit', 
        month: '2-digit', 
        year: 'numeric' 
    });
    
    // Obtener estad√≠sticas actuales
    const stats = estadisticasCache || {
        totalRequi: 0,
        totalDes: 0,
        completitup: 0,
        totalSKU: 0,
        totalSKUSinDes: 0,
        cantidadTotal: 0
    };
    
    const comentarioHTML = comentario.trim() !== '' ? `
        <div class="reporte-comentario-section">
            <div class="reporte-comentario-label">Observaciones y Comentarios</div>
            <div class="reporte-comentario-text">${comentario}</div>
        </div>
    ` : '';
    
    const html = `
        <div class="reporte-header-section">
            <div class="reporte-logo-container">
                <img src="https://hebbkx1anhila5yf.public.blob.vercel-storage.com/logo.png-aDTYH1bst5kbULe4iWpNW4HASl8UN8.png" alt="Farmacia Bola√±os" class="reporte-logo">
            </div>
            <div class="reporte-header-info">
                <h1 class="reporte-empresa-nombre">FARMACIA BOLA√ëOS</h1>
                <p class="reporte-empresa-contacto">10 AV. SUR ENTRE 13 Y 15 C. PTE, MERCADO COLON, SANTA ANA</p>
                <p class="reporte-empresa-contacto">Tel: 503 7922 2103 | Email: bolanosventademedicina@gmail.com</p>
            </div>
        </div>
        
        <div class="reporte-title-section">
            <h2 class="reporte-title">Reporte de Gesti√≥n de Despachos</h2>
            <div class="reporte-id">${reporteID}</div>
        </div>
        
        <div class="reporte-info-section">
            <div class="reporte-info-box">
                <div class="reporte-info-label">Fecha de Emisi√≥n</div>
                <div class="reporte-info-value">${fechaFormateada}</div>
            </div>
            <div class="reporte-info-box">
                <div class="reporte-info-label">Hora de Emisi√≥n</div>
                <div class="reporte-info-value">${horaFormateada}</div>
            </div>
            <div class="reporte-info-box">
                <div class="reporte-info-label">V√°lido Hasta</div>
                <div class="reporte-info-value">${fechaValidezFormateada}</div>
            </div>
        </div>
        
        <div class="reporte-stats-section">
            <h3 class="reporte-section-title">Resumen Ejecutivo de Indicadores</h3>
            <table class="reporte-stats-table">
                <thead>
                    <tr>
                        <th>Indicador</th>
                        <th>Valor</th>
                        <th>Descripci√≥n</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td class="reporte-stat-label-cell">Total Requisiciones</td>
                        <td class="reporte-stat-value-cell">${stats.totalRequi.toLocaleString()}</td>
                        <td>N√∫mero total de requisiciones procesadas</td>
                    </tr>
                    <tr>
                        <td class="reporte-stat-label-cell">Total Despachadas</td>
                        <td class="reporte-stat-value-cell">${stats.totalDes.toLocaleString()}</td>
                        <td>Requisiciones completamente despachadas</td>
                    </tr>
                    <tr>
                        <td class="reporte-stat-label-cell">Tasa de Completitud</td>
                        <td class="reporte-stat-value-cell">${stats.completitup}%</td>
                        <td>Porcentaje de requisiciones completadas</td>
                    </tr>
                    <tr>
                        <td class="reporte-stat-label-cell">SKU Procesados</td>
                        <td class="reporte-stat-value-cell">${stats.totalSKU.toLocaleString()}</td>
                        <td>C√≥digos √∫nicos de productos procesados</td>
                    </tr>
                    <tr>
                        <td class="reporte-stat-label-cell">SKU Sin Despachar</td>
                        <td class="reporte-stat-value-cell">${stats.totalSKUSinDes.toLocaleString()}</td>
                        <td>Productos sin despacho pendientes</td>
                    </tr>
                    <tr>
                        <td class="reporte-stat-label-cell">Cantidad Total Procesada</td>
                        <td class="reporte-stat-value-cell">${stats.cantidadTotal.toLocaleString()}</td>
                        <td>Unidades totales procesadas en el per√≠odo</td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        ${comentarioHTML}
        
        <div class="reporte-footer">
            <div class="reporte-firmas-section">
                <div class="reporte-firma-box">
                    <div class="reporte-firma-linea"></div>
                    <div class="reporte-firma-label">Elaborado Por</div>
                    <div class="reporte-firma-cargo">Digitador de Planta</div>
                </div>
                <div class="reporte-firma-box">
                    <div class="reporte-firma-linea"></div>
                    <div class="reporte-firma-label">Revisado Por</div>
                    <div class="reporte-firma-cargo">Gerente de Operaciones</div>
                </div>
            </div>
            
            <div class="reporte-footer-info">
                <p class="reporte-footer-text">Este documento ha sido generado autom√°ticamente por el Sistema de Gesti√≥n de Despachos</p>
                <p class="reporte-footer-text">Farmacia Bola√±os - Todos los derechos reservados ${ahora.getFullYear()}</p>
                <p class="reporte-footer-confidencial">‚ö† Documento Confidencial - Uso Interno Exclusivo</p>
            </div>
        </div>
    `;
    
    document.getElementById('reportePreview').innerHTML = html;
    
    // Guardar el ID del reporte para usarlo en el nombre del archivo
    document.getElementById('reportePreview').dataset.reporteId = reporteID;
}

function abrirReporteSKUSinDes() {
    // Generar datos de SKU sin despachar si no est√°n en cach√©
    if (!datosSKUSinDesCache) {
        const datosFiltrados = filtroActivo.fecha ? 
            tablaDatos.filter(fila => cumpleFiltroFechaHora(fila)) : 
            tablaDatos;
        
        // Primero filtramos todos los productos con cantidad 0 que cumplen criterios
        const productosSinDespachar = datosFiltrados.filter(fila => {
            const cantidad = obtenerValor(fila, ["CANTIDAD", "Cantidad", "cantidad"]);
            const codigo = obtenerValor(fila, ["CODIGO", "Codigo", "codigo"]);
            
            if ((cantidad === '0' || cantidad === 0) && codigo && codigo !== '-') {
                return camposDespachoRellenados(fila);
            }
            return false;
        });
        
        // Contar cu√°ntas veces se solicit√≥ cada c√≥digo de producto
        const contadorPorCodigo = {};
        productosSinDespachar.forEach(fila => {
            const codigo = obtenerValor(fila, ["CODIGO", "Codigo", "codigo"]);
            if (codigo) {
                contadorPorCodigo[codigo] = (contadorPorCodigo[codigo] || 0) + 1;
            }
        });
        
        // Agrupar por c√≥digo para mostrar cada producto solo una vez
        const productosAgrupados = {};
        productosSinDespachar.forEach(fila => {
            const codigo = obtenerValor(fila, ["CODIGO", "Codigo", "codigo"]);
            if (codigo && !productosAgrupados[codigo]) {
                productosAgrupados[codigo] = fila;
            }
        });
        
        // Convertir el objeto agrupado a array y agregar el conteo de solicitudes
        datosSKUSinDesCache = Object.keys(productosAgrupados).map(codigo => {
            const fila = productosAgrupados[codigo];
            return {
                ...fila,
                solicitudCount: contadorPorCodigo[codigo] // Agregar el conteo
            };
        });
    }
    
    // Generar HTML de la tabla si no est√° en cach√©
    if (!modalHTMLCache) {
        let html = '';
        datosSKUSinDesCache.forEach(fila => {
            // Usar el conteo de solicitudes calculado
            const solicitado = fila.solicitudCount || 1;
            html += `
                <tr>
                    <td>${obtenerValor(fila, ["ID", "id"]) || '-'}</td>
                    <td>${obtenerValor(fila, ["FECHA_Y_HORA", "FECHA Y HORA", "Fecha y Hora"]) || '-'}</td>
                    <td>${obtenerValor(fila, ["CODIGO", "Codigo", "codigo"]) || '-'}</td>
                    <td>${obtenerValor(fila, ["PRODUCTO", "Producto", "producto"]) || '-'}</td>
                    <td>${obtenerValor(fila, ["LABORATORIO", "Laboratorio", "laboratorio"]) || '-'}</td>
                    <td>${obtenerValor(fila, ["CANTIDAD", "Cantidad", "cantidad"]) || '-'}</td>
                    <td>${solicitado}</td>
                    <td>${obtenerValor(fila, ["INICIO", "HORA_INICIO", "HORA INICIO", "Hora Inicio", "hora_inicio", "HORA_DESPACHO", "HORA DESPACHO"]) || '-'}</td>
                    <td>${obtenerValor(fila, ["FIN", "HORA_FIN", "HORA FIN", "Hora Fin", "hora_fin"]) || '-'}</td>
                    <td>${obtenerValor(fila, ["PIKER", "Piker", "piker", "PICKER", "Picker"]) || '-'}</td>
                </tr>
            `;
        });
        modalHTMLCache = html;
    }
    
    // Actualizar el contenido del modal
    document.getElementById('modalTableBody').innerHTML = modalHTMLCache;
    
    // Actualizar el texto informativo
    const infoText = `<strong>Informaci√≥n:</strong> Este reporte muestra ${datosSKUSinDesCache.length} requisiciones con cantidad 0 que cumplen los criterios de SKU Sin Despachar (campos de despacho rellenados, sin palabras clave inv√°lidas).`;
    document.getElementById('modalInfoText').innerHTML = infoText;
    
    // Mostrar el modal
    document.getElementById('modalReporteSKU').classList.add('active');
    document.body.style.overflow = 'hidden';
}

function cerrarReporteSKUSinDes() {
    document.getElementById('modalReporteSKU').classList.remove('active');
    document.body.style.overflow = 'auto';
}


document.addEventListener('keydown', (event) => {
    if (event.key === 'Escape') {
        cerrarReporteSKUSinDes();
        cerrarModalReporte();
    }
});

document.addEventListener('DOMContentLoaded', () => {
    obtenerDatosCSV();
    iniciarAutoRefresh();
});

/* =====================================================
   FUNCIONES PARA MODAL PORCENTAJE SKU
   Agregar DESPUES de tus declaraciones de variables
   NO DECLARA estadisticasCache - usa la tuya existente
   ===================================================== */

// Ensure estadisticasCache is declared before use
var estadisticasCache

function abrirModalPorcentajeSKU() {
  if (!estadisticasCache) {
    alert("No hay datos cargados. Espera a que se carguen los datos.")
    return
  }

  var skuTotal = estadisticasCache.totalSKU || 0
  var skuSinDes = estadisticasCache.totalSKUSinDes || 0
  var skuDespachados = skuTotal - skuSinDes

  var porcentaje = 0
  if (skuTotal > 0) {
    porcentaje = ((skuDespachados / skuTotal) * 100).toFixed(1)
  }

  document.getElementById("modalTotalSKU").textContent = skuTotal.toLocaleString()
  document.getElementById("modalDespachados").textContent = skuDespachados.toLocaleString()
  document.getElementById("modalPendientes").textContent = skuSinDes.toLocaleString()
  document.getElementById("pctNumber").textContent = porcentaje

  var offset = 327 - (porcentaje / 100) * 327
  var gauge = document.getElementById("gaugeProgress")
  gauge.style.strokeDashoffset = offset

  if (porcentaje >= 95) {
    gauge.style.stroke = "#22c55e"
  } else if (porcentaje >= 80) {
    gauge.style.stroke = "#eab308"
  } else if (porcentaje >= 60) {
    gauge.style.stroke = "#f97316"
  } else {
    gauge.style.stroke = "#ef4444"
  }

  var status = document.getElementById("pctStatus")
  status.className = "pct-status"

  if (porcentaje >= 95) {
    status.classList.add("excelente")
    status.textContent = "Excelente"
  } else if (porcentaje >= 80) {
    status.classList.add("bueno")
    status.textContent = "Bueno"
  } else if (porcentaje >= 60) {
    status.classList.add("regular")
    status.textContent = "Regular"
  } else {
    status.classList.add("bajo")
    status.textContent = "Bajo"
  }

  document.getElementById("modalPorcentajeSKU").classList.add("active")
  document.body.style.overflow = "hidden"
}

function cerrarModalPorcentajeSKU() {
  document.getElementById("modalPorcentajeSKU").classList.remove("active")
  document.body.style.overflow = "auto"
  document.getElementById("gaugeProgress").style.strokeDashoffset = 327
}

document.addEventListener("DOMContentLoaded", () => {
  var modal = document.getElementById("modalPorcentajeSKU")
  if (modal) {
    modal.addEventListener("click", function (e) {
      if (e.target === this) {
        cerrarModalPorcentajeSKU()
      }
    })
  }
})




</script>

<!-- MODAL PORCENTAJE SKU - Agregar antes de </body> -->
<div id="modalPorcentajeSKU" class="modal-pct-overlay">
    <div class="modal-pct-content" onclick="event.stopPropagation()">
        <h2 class="modal-pct-title">Eficiencia de Despacho SKU</h2>
        
        <!-- Gauge circular -->
        <div class="pct-gauge">
            <svg viewBox="0 0 120 120">
                <circle cx="60" cy="60" r="52" class="gauge-track"/>
                <circle cx="60" cy="60" r="52" class="gauge-progress" id="gaugeProgress"/>
            </svg>
            <div class="pct-value">
                <span id="pctNumber">0</span><span class="pct-symbol">%</span>
            </div>
        </div>
        
        <!-- Stats -->
        <div class="pct-stats">
            <div class="pct-stat">
                <span class="pct-stat-value" id="modalTotalSKU">0</span>
                <span class="pct-stat-label">Total SKU</span>
            </div>
            <div class="pct-stat pct-stat-ok">
                <span class="pct-stat-value" id="modalDespachados">0</span>
                <span class="pct-stat-label">Despachados</span>
            </div>
            <div class="pct-stat pct-stat-warning">
                <span class="pct-stat-value" id="modalPendientes">0</span>
                <span class="pct-stat-label">Sin Despachar</span>
            </div>
        </div>
        
        <!-- Status -->
        <div class="pct-status" id="pctStatus"></div>
    </div>
</div>
</body>
</html>

